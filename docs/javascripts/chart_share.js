/**
 * Final Viral Chart Script
 * Includes Lazy Loading (Intersection Observer)
 */

// -------------------------------------------------------------
// PART 1: Share & Copy Logic (Kept exactly the same)
// -------------------------------------------------------------
async function shareChart(elementId) {
    var dom = document.getElementById(elementId);
    if (!dom) return;

    var chartInstance = echarts.getInstanceByDom(dom);
    if (!chartInstance) {
        // If user scrolls too fast and clicks before animation starts
        alert("Chart is loading... please wait a moment."); 
        return;
    }

    // 1. Get Image Data
    var dataURL = chartInstance.getDataURL({
        type: 'png',
        pixelRatio: 2,
        backgroundColor: '#ffffff'
    });

    // 2. Prepare Blob
    var blob = await (await fetch(dataURL)).blob();
    var file = new File([blob], "osint_analysis.png", { type: "image/png" });
    var shareText = `Read more: ${window.location.href}`;

    // 3. Android Clipboard Fix
    try {
        await navigator.clipboard.writeText(shareText);
        showToast("URL copied! Paste it in your post ðŸ“‹");
    } catch (err) {
        console.log("Clipboard failed (non-HTTPS site?)");
    }

    // 4. Native Share or Fallback
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
            await navigator.share({
                files: [file],
                title: 'OSINT Report',
                text: shareText 
            });
        } catch (error) {
            console.log("Share closed", error);
        }
    } else {
        try {
            const item = new ClipboardItem({ 'image/png': blob });
            await navigator.clipboard.write([item]);
            alert("Image copied! \n(Caption is also in your clipboard)");
        } catch (err) {
            alert("Browser does not support sharing.");
        }
    }
}

function showToast(message) {
    var toast = document.createElement("div");
    toast.innerText = message;
    toast.style.position = "fixed";
    toast.style.top = "30%";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.backgroundColor = "rgba(0,0,0,0.8)";
    toast.style.color = "#fff";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "20px";
    toast.style.zIndex = "9999";
    toast.style.fontSize = "20px";
    toast.style.transition = "opacity 0.5s";
    
    document.body.appendChild(toast);
    setTimeout(function() {
        toast.style.opacity = "0";
        setTimeout(function() { document.body.removeChild(toast); }, 500);
    }, 3000);
}

async function copyPageUrl() {
    try {
        await navigator.clipboard.writeText(window.location.href);
        showToast("Page link copied! ðŸ”—");
    } catch (err) {
        prompt("Copy this link:", window.location.href);
    }
}

// -------------------------------------------------------------
// PART 2: Lazy Load Logic (UPDATED)
// -------------------------------------------------------------

document.addEventListener("DOMContentLoaded", function () {
    // 1. Setup the Observer
    const chartObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const dom = entry.target;
                const id = dom.id;
                
                // Retrieve the data stored by python
                const options = window.osintChartData ? window.osintChartData[id] : null;

                if (options && typeof echarts !== 'undefined') {
                    // Check if already initialized to avoid double-render
                    if (echarts.getInstanceByDom(dom)) return;

                    // Initialize
                    const myChart = echarts.init(dom);
                    
                    // Add default padding for the buttons if missing
                    if (!options.grid) {
                        options.grid = { top: 60, right: 20, bottom: 20, left: 40, containLabel: true };
                    }

                    myChart.setOption(options);

                    // Resize handler
                    window.addEventListener('resize', function() { myChart.resize(); });
                    
                    // Stop observing this element (it's loaded now)
                    observer.unobserve(dom);
                }
            }
        });
    }, { 
        threshold: 0.3 // Trigger when 30% of chart is visible
    });

    // 2. Find all charts generated by the Python macro
    const lazyCharts = document.querySelectorAll('.lazy-chart');
    lazyCharts.forEach(chart => {
        chartObserver.observe(chart);
    });
});
